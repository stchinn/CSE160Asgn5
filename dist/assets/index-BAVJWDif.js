import*as r from"https://cdn.jsdelivr.net/npm/three@0.130.1/build/three.module.js";import{OBJLoader as q}from"https://cdn.jsdelivr.net/npm/three@0.130.1/examples/jsm/loaders/OBJLoader.js";import{MTLLoader as H}from"https://cdn.jsdelivr.net/npm/three@0.130.1/examples/jsm/loaders/MTLLoader.js";import{GUI as T}from"https://cdn.jsdelivr.net/npm/three@0.130.1/examples/jsm/libs/lil-gui.module.min.js";import{OrbitControls as U}from"https://cdn.jsdelivr.net/npm/three@0.130.1/examples/jsm/controls/OrbitControls.js";(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(t){if(t.ep)return;t.ep=!0;const o=n(t);fetch(t.href,o)}})();let l=new r.Scene,h,u;function N(e){return h=new r.WebGLRenderer({antialias:!0,canvas:e,logarithmicDepthBuffer:!0}),h.setClearColor(11184810),h.shadowMap.enabled=!0,h}function J(e=60){return u=new r.PerspectiveCamera(e,2,.1,1e3),u.position.set(8,4,10).multiplyScalar(3),u.lookAt(0,0,0),u}function K(){const e=new r.DirectionalLight(0,5);e.position.set(0,20,0),e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048;const a=50;e.shadow.camera.left=-50,e.shadow.camera.right=a,e.shadow.camera.top=a,e.shadow.camera.bottom=-50,e.shadow.camera.near=1,e.shadow.camera.far=50,e.shadow.bias=.001;const n=new r.DirectionalLight(11189213,1);n.position.set(f.x,f.y,f.z),n.target.position.set(0,0,0);const s=new r.AmbientLight(4210752,1);return l.add(s),l.add(e),l.add(n),l.add(n.target),l.fog=new r.Fog(5578515,10,400),l}class W{constructor(a,n,s,t){this.obj=a,this.minProp=n,this.maxProp=s,this.minDif=t}get min(){return this.obj[this.minProp]}set min(a){this.obj[this.minProp]=a,this.obj[this.maxProp]=Math.max(this.obj[this.maxProp],a+this.minDif)}get max(){return this.obj[this.maxProp]}set max(a){this.obj[this.maxProp]=a,this.min=this.min}}function k(){u.updateProjectionMatrix()}let f={x:300,y:80,z:300};function Z(){const e=new r.TextureLoader,a={ambientOcclusion:e.load("textures/Moon_002_ambientOcclusion.png"),basecolor:e.load("textures/Moon_002_basecolor.png"),height:e.load("textures/Moon_002_height.png"),normal:e.load("textures/Moon_002_normal.png"),roughness:e.load("textures/Moon_002_roughness.png")},n=new r.SphereGeometry(5,32,32),s=new r.MeshStandardMaterial({map:a.basecolor,normalMap:a.normal,roughnessMap:a.roughness,aoMap:a.ambientOcclusion,displacementMap:a.height,displacementScale:.05,transparent:!0,opacity:.5}),t=new r.Mesh(n,s);return t.scale.set(48,48,48),t.position.set(f.x,f.y,f.z),t}function Q(){const e=new r.PlaneGeometry(5e3,5e3),a=new r.MeshPhongMaterial({color:10135470}),n=new r.Mesh(e,a);return n.rotation.x=Math.PI*-.5,n.receiveShadow=!0,n.position.y=-1,n}function V(e,a,n,s){const t=new r.Object3D,o=new r.BoxGeometry(e,a,n),i=new r.MeshPhongMaterial({color:6719658}),c=new r.Mesh(o,i);c.position.y=1.4,c.castShadow=!0,t.add(c);const d=new r.PerspectiveCamera(s,2,.1,1e3);d.position.y=3,d.position.z=-6,d.rotation.y=Math.PI,c.add(d);const y=1,p=.5,R=6,I=new r.CylinderGeometry(y,y,p,R),O=new r.MeshPhongMaterial({color:8947848}),j=[[-4/2-p/2,-1/2,n/3],[e/2+p/2,-1/2,n/3],[-4/2-p/2,-1/2,0],[e/2+p/2,-1/2,0],[-4/2-p/2,-1/2,-8/3],[e/2+p/2,-1/2,-8/3]].map(m=>{const g=new r.Mesh(I,O);return g.position.set(...m),g.rotation.z=Math.PI*.5,g.castShadow=!0,c.add(g),g}),_=2,v=new r.SphereGeometry(_,12,12,0,Math.PI*2,0,Math.PI*.5),P=new r.Mesh(v,i);P.castShadow=!0,c.add(P),P.position.y=.5;const B=.1,D=.1,A=n*.75*.2,E=new r.BoxGeometry(B,D,A),w=new r.Mesh(E,i),x=new r.Object3D;w.castShadow=!0,x.scale.set(5,5,5),x.position.y=.5,w.position.z=A*.5,x.add(w),c.add(x);const S=new r.PerspectiveCamera(75,2,.1,1e3);S.position.y=.75*.2,w.add(S);let M=0,b=0,z=0;t.scale.set(.6,.6,.6),document.addEventListener("keydown",m=>{m.key==="w"?(M=.2,z=.1):m.key==="s"?(M=-.2,z=-.1):m.key==="a"?b=.05:m.key==="d"&&(b=-.05)}),document.addEventListener("keyup",m=>{m.key==="w"||m.key==="s"?(M=0,z=0):(m.key==="a"||m.key==="d")&&(b=0)});function F(){c.translateZ(M),c.rotation.y+=b,j.forEach(m=>{m.rotation.x+=z})}function G(){F(),requestAnimationFrame(G)}return G(),{tank:t,bodyMesh:c,turretMesh:w,turretCamera:S,tankCamera:d,wheelMeshes:j}}function C(e,a,n={x:0,y:0,z:0},s={x:1,y:1,z:1},t={x:0,y:0,z:0}){new H().load(a,i=>{const c=new q;c.setMaterials(i),c.load(e,d=>{l.add(d),d.position.set(n.x,n.y,n.z),d.scale.set(s.x,s.y,s.z),d.rotation.set(t.x,t.y,t.z)})})}function X(){const e=new r.BoxGeometry(1e3,1e3,1e3),a=new r.MeshBasicMaterial({color:5148,side:r.BackSide});return new r.Mesh(e,a)}function Y(){const e=h.domElement,a=e.clientWidth,n=e.clientHeight,s=e.width!==a||e.height!==n;return s&&h.setSize(a,n,!1),s}function $(e,a){let n=2;return document.addEventListener("keydown",s=>{s.key===" "&&(n=(n+1)%e.length)}),function s(t){if(Y()){const i=h.domElement;i&&e.forEach(c=>{const d=c.cam;d&&(d.aspect=i.clientWidth/i.clientHeight,d.updateProjectionMatrix())})}const o=e[n];if(o&&o.cam){const i=o.cam;a.textContent=o.desc,i.updateProjectionMatrix(),h.render(l,i)}else o&&o.updateProjectionMatrix?(a.textContent=o.desc,o.updateProjectionMatrix(),h.render(l,o)):console.error("Selected camera or camera.cam is undefined or invalid.");requestAnimationFrame(s)}}function ee(){const e={x:10,y:10,z:10},n={x:0,y:90*Math.PI/180,z:0};let s=-210,t=-210;for(let o=0;o<10;o++)for(let i=0;i<10;i++){let c=s+o*40,d=t+i*40;C("/models/large_buildingA.obj","/models/large_buildingA.mtl",{x:c,y:0,z:d},e,n)}}function te(){const e={x:.2,y:.2,z:.2},n={x:-(90*Math.PI/180),y:0,z:0};let s=-210,t=-239;for(let o=0;o<20;o++)for(let i=0;i<10;i++){let c=s+o*25,d=t+i*41;C("/models/roadtile.obj","/models/roadtile.mtl",{x:c,y:-1,z:d},e,n)}}let L=[];function oe(){const e={x:2,y:3,z:2},a={x:0,y:0,z:0};let n=-210,s=-228;for(let t=0;t<20;t++)for(let o=0;o<10;o++){let i=n+t*25,c=s+o*41;L.push({x:i,z:c}),C("/models/streetlamp.obj","/models/streetlamp.mtl",{x:i,y:6,z:c},e,a)}for(let t=0;t<5;t++){const o=new r.SpotLight(16777215,100);o.position.set(L[t].x,5,L[t].z),o.castShadow=!0,o.angle=Math.PI/2,l.add(o)}}function ne(){const e=document.querySelector("#c"),a=X(),n=Q(),s=V(4,1,8,75),t=Z();l=K(),h=N(e),u=J(),l.add(a),l.add(t),l.add(n),l.add(s.tank);const o=document.querySelector("#info"),i=[{cam:u,desc:"detached camera (press space to change)"},{cam:s.turretCamera,desc:"on turret looking at target (press space to change)"},{cam:s.tankCamera,desc:"above back of tank (wasd, spacebar)"}],c=new T;c.add(u,"fov",1,180).onChange(k);const d=new W(u,"near","far",.1);c.add(d,"min",.1,50,.1).name("near").onChange(k),c.add(d,"max",.1,50,.1).name("far").onChange(k);const y=new U(u,e);y.target.set(0,0,0),y.update(),te(),oe(),ee();const p=$(i,o);requestAnimationFrame(p)}ne();
